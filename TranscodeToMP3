#!/bin/zsh

# Written by Nick Welch <nick@incise.org>.  Author disclaims copyright.

# TranscodeToMP3: recursively find all files in the current directory with the
# specified extension (the only argument) and convert them to mp3, using
# mplayer to decode them, changing the extension to .mp3 in the new files'
# filenames and leaving the original files intact.

extension="$1"
threads=2

if [ "$extension" -eq ".mp3" ]
then
    echo "don't do that, it'll overwrite your files"
    exit 1
fi

#i=0
#files=()
#find . -name "*$extension" | sort | while read file
#do
#    files[$i]="$file"
#    i=$(($i+1))
#done

start=`date +%s`

elapsed_time()
{
    now=`date +%s`
    elapsed=$(($now - $start))
    minutes=$(($elapsed / 60))
    seconds=$(($elapsed % 60))
    printf "%02d:%02d" $minutes $seconds
}

transcode_file()
{
    filename="$1"
    mkfifo "$filename".pipe
    mp3_filename=`basename "$filename" "$extension"`.mp3
    DoItEasy mplayer -really-quiet -noconsolecontrols -ao pcm:file="$filename".pipe "$filename" 2>/dev/null &
    DoItEasy lame --quiet --preset extreme "$filename".pipe "$mp3_filename"
    rm -f "$filename".pipe
    echo T+`elapsed_time`" finished: $filename"
}

# launch them all gradually

echo "launching $threads threads at a time..."

find . -name "*$extension" | sort | while read file
do
    while [ `jobs | wc -l` -ge $threads ]
    do
        sleep 0.2
    done
    transcode_file "$file" &
done

wait

